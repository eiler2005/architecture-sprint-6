# Список проблем и рисков текущей архитектуры InsureTech

## 1. Проблемы:
1. **Высокая частота синхронных запросов между сервисами:**
    - `core-app` и `ins-comp-settlement` часто запрашивают `ins-product-aggregator` для получения данных, что приводит к задержкам в ответах.
    - Возможны частые таймауты при взаимодействии с API страховых компаний.

2. **Слабая масштабируемость:**
    - Нагрузка на `ins-product-aggregator` увеличивается пропорционально росту числа страховых компаний.
    - Увеличение количества партнеров может привести к деградации производительности.

3. **Зависимость от внешних API:**
    - Ошибки в интеграции с API страховых компаний негативно сказываются на работе внутренних сервисов.

4. **Ограничения на обработку данных:**
    - Реплики данных в `core-app` и `ins-comp-settlement` требуют периодического обновления через синхронные запросы, что создает дополнительную нагрузку.

5. **Риски несогласованности данных:**
    - Использование локальных реплик без механизмов согласованности может приводить к устареванию данных.

6. **Уязвимость при росте числа запросов:**
    - Пиковая нагрузка на сервисы (`ins-product-aggregator`, `core-app`) может привести к отказам в обслуживании.

7. **Сложности синхронизации данных:**
    - Различная периодичность запросов (раз в 15 минут и раз в сутки) создает расхождения в данных между core-app и ins-comp-settlement.

## 2. Риски:
1. **Снижение производительности из-за роста партнеров (страховые компании):**
    - Подключение новых страховых компаний увеличит объем обрабатываемых данных, что повлияет на время обработки запросов.

2. **Задержки в обработке из-за зависимости от внешних систем:**
    - Высокая задержка или недоступность API страховых компаний приведет к сбоям в `core-app` и `ins-comp-settlement`.

3. **Отсутствие обработки событий в реальном времени:**
    - Архитектура не поддерживает реактивные изменения данных, что затрудняет масштабирование и оперативное обновление.

4. **Риски при переходе на новую архитектуру:**
    - Перевод взаимодействий на Event-Driven может потребовать значительных изменений в коде сервисов и инфраструктуре.

5. **Увеличение сложности управления данными:**
    - Хранение локальных реплик требует разработки механизмов синхронизации и разрешения конфликтов.

## Вывод:
Текущая архитектура InsureTech имеет несколько проблем, связанных с синхронным взаимодействием и зависимостью от внешних API. Для улучшения работы необходимо перейти на Event-Driven подход, который позволит:
- Уменьшить нагрузку на `ins-product-aggregator`.
- Улучшить масштабируемость.
- Устранить проблемы с согласованностью данных.

В рамках предложенного решения следует рассмотреть использование Transactional Outbox для упрощения интеграции и обеспечения надежности и точки зрения масштабирумости перейти на EDA. 
Как это можно сделать - подумаем ниже?

## 3.1. Предложение по улучшению. Применение Event-Driven Architecture (EDA) в InsureTech

### Проблемы текущей архитектуры (которые можем решить с помощью EDA):
1. **Синхронные вызовы между сервисами:**
    - `core-app` и `ins-comp-settlement` запрашивают данные у `ins-product-aggregator` через REST API. Это вызывает:
        - Задержки из-за ожидания ответа.
        - Ошибки при недоступности `ins-product-aggregator` или API страховых компаний.
    - Частота запросов (раз в 15 минут и раз в сутки) может привести к пиковым нагрузкам.

2. **Отсутствие асинхронности:**
    - Все взаимодействия зависят от выполнения запросов "здесь и сейчас", что снижает общую отказоустойчивость системы.

3. **Риск роста нагрузки:**
    - Подключение новых страховых компаний увеличит нагрузку на `ins-product-aggregator` и может вызвать его деградацию.

### Решение через EDA:
1. **Введение брокера сообщений:**
    - Использование Kafka, RabbitMQ или аналогичного брокера для публикации событий.
    - Например, `ins-product-aggregator` публикует событие **"Обновление данных продуктов"**.

2. **Изменение взаимодействий:**
    - `core-app` и `ins-comp-settlement` больше не отправляют синхронные запросы к `ins-product-aggregator`. Вместо этого они подписываются на события, публикуемые брокером.
    - Пример событий:
        - `product.updated` — данные о продуктах и тарифах.
        - `settlement.completed` — информация о завершенных сделках.

3. **Локальные реплики данных:**
    - `core-app` и `ins-comp-settlement` поддерживают свои локальные копии данных о продуктах, синхронизируемые через события. Это минимизирует количество запросов и снижает нагрузку на брокер.

4. **Гибкость и масштабируемость:**
    - При добавлении новых страховых компаний события автоматически обрабатываются существующими подписчиками.
    - Новые сервисы могут быть подключены без изменения текущих.

---

## 3.2. Предложение по улучшению. Применение Transactional Outbox в InsureTech

### Проблемы текущей архитектуры:
1. **Риск разрыва транзакции:**
    - Если `core-app` обновляет свои данные и одновременно отправляет событие в брокер, сбой в одном из этапов может привести к неконсистентности данных.
    - Пример: данные о новом страховом продукте записаны в базу, но не отправлены в `ins-product-aggregator`.

2. **Зависимость от доступности брокера:**
    - Если брокер недоступен, события теряются, что приводит к рассинхронизации данных.

### Решение через Transactional Outbox:
1. **Использование таблицы Outbox:**
    - Каждое событие (например, о новом продукте) записывается в таблицу `outbox` вместе с основными изменениями в базе данных.
    - Это действие выполняется в рамках одной транзакции, что гарантирует консистентность.

2. **Обработчик событий:**
    - Фоновый процесс (например, Debezium) периодически читает таблицу `outbox` и отправляет события в брокер сообщений.
    - После успешной отправки запись из `outbox` удаляется.

3. **Преимущества для InsureTech:**
    - `core-app` и `ins-comp-settlement` используют outbox для отправки событий о новых продуктах и статусах сделок.
    - Даже в случае сбоя брокера события сохраняются и будут отправлены позже.

4. **Пример применения:**
    - При добавлении нового страхового продукта `core-app` записывает информацию в свою основную таблицу и outbox.
    - Обработчик событий публикует сообщение **"Новый продукт добавлен"**, которое подхватывается `ins-comp-settlement`.

---

## 3.3. Предложение по улучшению. Итоги

1. **Преимущества Event-Driven Architecture (EDA):**
    - Уменьшение зависимости между сервисами.
    - Повышение масштабируемости системы.
    - Асинхронное взаимодействие снижает риск задержек и таймаутов.
    - Легкость интеграции новых сервисов и страховых компаний.

2. **Преимущества Transactional Outbox:**
    - Гарантия консистентности данных между базой данных и брокером сообщений.
    - Надежность публикации событий даже при сбоях.
    - Упрощение обработки событий и снижение риска потери данных.

3. **Рекомендации:**
    - Перевести взаимодействие между `core-app`, `ins-comp-settlement` и `ins-product-aggregator` на Event-Streaming.
    - Внедрить Transactional Outbox для публикации событий в `core-app` и `ins-comp-settlement`.
    - Выбрать надежный брокер сообщений (Kafka, RabbitMQ) для обработки большого количества событий.
    - Планировать масштабирование брокера сообщений с учетом увеличения количества страховых компаний.

Эти изменения помогут InsureTech адаптироваться к растущей нагрузке, повысить надежность системы и улучшить пользовательский опыт.
